name: Build Custom WRT

on:
  workflow_dispatch:
    inputs:
      project:
        description: "é€‰æ‹© WRT é¡¹ç›®"
        required: true
        default: "openwrt"
        type: choice
        options:
          - openwrt
          - immortalwrt
          - x-wrt
          - lienol
          - lede
      version_type:
        description: "ç‰ˆæœ¬ç±»å‹"
        required: true
        default: "stable"
        type: choice
        options:
          - "snapshot"
          - "stable"
      branch:
        description: "snapshot-branch"
        required: false
        default: "master"
        type: string
      tag:
        description: "stable-tag"
        required: false
        default: "v24.10.2"
        type: string
      config_path:
        description: "configè·¯å¾„"
        required: true
        default: "config/openwrt-linksys-e8450"
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Determine Git ref
        id: refinfo
        run: |
          if [ "${{ inputs.version_type }}" = "snapshot" ]; then
            echo "ref=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gettext git \
            libncurses-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync unzip zlib1g-dev file wget curl \
            gzip tar zip xz-utils bzip2 zstd \
            make cmake autoconf automake libtool patch diffutils \
            findutils grep sed help2man texinfo \
            libelf-dev libfuse-dev liblzma-dev libxml2-dev libyaml-dev \
            uuid-dev device-tree-compiler antlr3 gperf \
            time bc jq xxd swig upx-ucl ccache ecj fastjar imagemagick

      - name: Determine Git URL
        id: projectinfo
        run: |
          case "${{ inputs.project }}" in
            immortalwrt)
              echo "url=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_OUTPUT
              ;;
            x-wrt)
              echo "url=https://github.com/x-wrt/x-wrt.git" >> $GITHUB_OUTPUT
              ;;
            openwrt)
              echo "url=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_OUTPUT
              ;;
            lienol)
              echo "url=https://github.com/Lienol/openwrt.git" >> $GITHUB_OUTPUT
              ;;
            lede)
              echo "url=https://github.com/coolsnowwolf/lede.git" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "âŒ æœªçŸ¥é¡¹ç›®: ${{ inputs.project }}" >&2
              exit 1
              ;;
          esac

      - name: Clone selected WRT source
        run: |
          echo "ğŸ“¥ å…‹éš† ${{ inputs.project }} ä»“åº“ï¼Œref=${{ steps.refinfo.outputs.ref }}"
          git clone --branch "${{ steps.refinfo.outputs.ref }}" \
            "${{ steps.projectinfo.outputs.url }}" wrt

      - name: Clone Argon Luci Theme
        run: |
          echo "ğŸ¨ å…‹éš† luci-theme-argon ä¸»é¢˜ä¸­..."
          git clone https://github.com/jerrykuku/luci-theme-argon.git wrt/package/luci-theme-argon
          echo "âœ… luci-theme-argon å…‹éš†å®Œæˆ"

      - name: Clone luci-app-daed and libcron
        working-directory: wrt
        run: |
          echo "ğŸ“‚ å…‹éš† luci-app-daed æºç â€¦"
          git clone https://github.com/QiuSimons/luci-app-daed package/dae
          echo "âœ… luci-app-daed å…‹éš†å®Œæˆ"

          echo "ğŸ“‚ è·å– libcron Makefileâ€¦"
          mkdir -p Package/libcron
          wget -O Package/libcron/Makefile \
            https://raw.githubusercontent.com/immortalwrt/packages/refs/heads/master/libs/libcron/Makefile
          echo "âœ… libcron Makefile ä¸‹è½½å®Œæˆ"

      - name: Install DAE build dependencies
        run: |
          echo "ğŸ”§ å®‰è£… DAE ä¾èµ– (clang-15, llvm-15, npm, pnpm)â€¦"
          sudo apt-get update
          sudo apt-get install -y clang-15 llvm-15 npm
          npm install -g pnpm
          echo "âœ… DAE ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Build only luci-app-daed (debug)
        working-directory: wrt
        run: |
          echo "ğŸš§ å•ç‹¬ç¼–è¯‘ luci-app-daed ä»¥éªŒè¯â€¦"
          make package/dae/luci-app-daed/compile V=s
          echo "âœ… luci-app-daed ç¼–è¯‘å®Œæˆ"

      - name: Copy diy.sh to WRT
        run: |
          echo "ğŸ“‚ å¤åˆ¶ diy.sh åˆ° wrt ç›®å½•"
          cp diy.sh wrt/diy.sh

      - name: Run diy.sh
        working-directory: wrt
        run: |
          echo "ğŸ”§ æ‰§è¡Œ diy.sh"
          chmod +x diy.sh
          ./diy.sh

      - name: Update and install feeds
        working-directory: wrt
        run: |
          echo "ğŸ“¦ æ›´æ–° feeds"
          ./scripts/feeds update -a
          echo "ğŸ“¦ å®‰è£… feeds"
          ./scripts/feeds install -a

      - name: Setup configuration
        run: |
          echo "ğŸ“‹ å¤åˆ¶é…ç½®ï¼š${{ inputs.config_path }} â†’ wrt/.config"
          if [ ! -f "${{ inputs.config_path }}" ]; then
            echo "âŒ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ï¼š${{ inputs.config_path }}"
            exit 1
          fi
          cp "${{ inputs.config_path }}" wrt/.config
          cd wrt
          echo "ğŸ”„ è¿è¡Œ make oldconfig"
          make oldconfig

      - name: Download source packages
        working-directory: wrt
        run: |
          echo "â¬‡ï¸ ä¸‹è½½æ‰€æœ‰æºç åŒ…"
          make download -j8

      - name: Build Firmware
        working-directory: wrt
        run: |
          JOBS=$(nproc)
          echo "ğŸš€ å…¨é‡ç¼–è¯‘ï¼ˆå¹¶è¡Œ ${JOBS}ï¼‰å¼€å§‹"
          START=$(date "+%Y-%m-%d %H:%M:%S")
          echo "â±ï¸ ç¼–è¯‘å¼€å§‹ï¼š${START}"
          if ! time make world -j${JOBS} 2>&1 | tee build.log; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¾“å‡ºæœ€å 100 è¡Œæ—¥å¿—ï¼š"
            grep error ./build.log
            exit 1
          fi
          END=$(date "+%Y-%m-%d %H:%M:%S")
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          echo "â±ï¸ ç»“æŸï¼š${END}"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project }}-output
          path: |
            wrt/bin/targets/**/*.{img,bin,tar.gz,zip}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project }}-build-log
          path: wrt/build.log
